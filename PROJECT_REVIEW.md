# Financial Normalizer - Project Review & Testing Guide

## Project Overview

This is a **Financial Statement Normalization Engine** written in Python 3.12. It's designed to:

1. **Parse Trial Balance Data** - Read financial GL data from CSV/Excel files
2. **Classify Accounts** - Categorize accounts into standard types (revenue, COGS, OpEx, etc.)
3. **Detect Suspicious Patterns** - Flag unusual accounting entries
4. **Calculate Adjustments** - Track and apply adjustments to normalize financials
5. **Generate EBITDA Metrics** - Calculate reported, adjusted, and normalized EBITDA
6. **Handle Multi-Entity Consolidations** - Consolidate entities with eliminations

---

## Project Structure

```
financial-normalizer/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ categories.yaml          # Account classification rules (industry-specific)
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ input/
â”‚   â”‚   â””â”€â”€ sample_trial_balance.csv   # Sample GL data (GreenPower LLC example)
â”‚   â””â”€â”€ output/                  # Output files generated by processing
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py                  # Application entry point
â”‚   â”œâ”€â”€ classification/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ classifier.py        # Account classification engine
â”‚   â”œâ”€â”€ ingestion/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ trial_balance_parser.py      # Parse GL data from files
â”‚   â”‚   â””â”€â”€ synthetic_generators.py      # Generate test data
â”‚   â”œâ”€â”€ normalization/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ adjustments.py       # Adjustment calculations & EBITDA
â”‚   â”‚   â””â”€â”€ engine.py            # Main normalization orchestrator
â”‚   â””â”€â”€ export/
â”‚       â””â”€â”€ __init__.py          # Export module (currently empty)
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ __init__.py              # Test directory placeholder
â”œâ”€â”€ requirements.txt             # Python dependencies
â””â”€â”€ README.md                    # Project documentation

```

---

## File Structure & Purpose

### Core Modules

#### 1. **trial_balance_parser.py** (Complete âœ“)
- **Purpose**: Reads GL data from CSV/Excel files
- **Key Classes**:
  - `Transaction`: Data class for individual journal entries
  - `TrialBalanceParser`: Main parser with flexible column mapping
- **Features**:
  - Auto-detects column mappings (account, debit, credit, date, etc.)
  - Converts debits/credits to net amounts
  - Handles missing dates gracefully
  - Validates trial balance (debits = credits)
  - Flags large transactions for review

#### 2. **classifier.py** (Complete âœ“)
- **Purpose**: Classifies accounts into standard accounting categories
- **Key Classes**:
  - `AccountType`: Enum for account types (revenue, COGS, OpEx, asset, liability, equity, etc.)
  - `AdjustmentType`: Enum for adjustment categories (add_back, eliminate, normalize, etc.)
  - `SuspiciousPatternFlag`: Dataclass for flagging unusual accounts
  - `AccountClassification`: Result of classification
  - `ClassificationEngine`: Main classification orchestrator
- **Features**:
  - Industry-specific classification (SaaS, Manufacturing, Financial Services)
  - Keyword-based account matching
  - Adjustment detection and mapping
  - Suspicious pattern detection:
    - Negative revenue detection
    - Round number detection
    - Related party transaction detection

#### 3. **adjustments.py** (Complete âœ“)
- **Purpose**: Tracks and calculates financial adjustments
- **Key Classes**:
  - `AdjustmentCategory`: Enum for adjustment types
  - `EBITDAMetric`: Enum for EBITDA types (reported, adjusted, normalized)
  - `AdjustmentDetail`: Individual adjustment entry
  - `EBITDACalculation`: Complete EBITDA calculation output
  - `AdjustmentCalculator`: Main adjustment calculator
  - `ConsolidationEngine`: Multi-entity consolidation with eliminations
- **Features**:
  - Calculate reported EBITDA from GL data
  - Apply adjustments to calculate adjusted EBITDA
  - Apply normalizations for normalized EBITDA
  - Handles multi-currency (USD, EUR, GBP, CAD, MXN)
  - Intercompany elimination support
  - Impact analysis for each adjustment

#### 4. **engine.py** (Partial - Review section shown)
- **Purpose**: Main orchestrator for normalized view generation
- **Key Classes**:
  - `NormalizedViewConfig`: Configuration for processing
  - `BeforeAfterComparison`: Comparison dataclass
  - `NormalizedFinancialView`: Complete normalized output
  - `NormalizedViewEngine`: Main orchestrator
- **Features**:
  - Integrates classification and adjustment engines
  - Generates before/after comparisons
  - Creates income statements
  - Calculates All EBITDA metrics
  - Handles intercompany eliminations
  - Multi-entity support

#### 5. **synthetic_generators.py** (Partial - Review shown)
- **Purpose**: Generate realistic test data
- **Key Classes**:
  - `AccountScheme`: Enum for account numbering schemes
  - `Currency`: Enum for supported currencies
  - `SyntheticAccountGenerator`: Generate test GL data
- **Features**:
  - Multiple account numbering schemes (4-digit, 5-digit, alphanumeric)
  - Multi-currency support
  - Generate realistic accounting entries

#### 6. **categories.yaml** (Complete âœ“)
- **Purpose**: Configuration file for account classifications
- **Contents**:
  - Industry-specific account mappings (SaaS/Tech, Manufacturing, Financial Services)
  - Revenue, COGS, OpEx account definitions
  - Metrics and attributes for each account
  - Suspicious pattern rules
  - Adjustment definitions (keywords, adjustment type, etc.)

---

## Dependencies

**Python 3.12.3** with packages:
- `pandas==2.1.0` - Data manipulation
- `openpyxl==3.1.2` - Excel file support
- `pyyaml==6.0.1` - YAML config parsing
- `anthropic==0.25.0` - Claude API integration (optional)
- `python-dotenv==1.0.0` - Environment variables

---

## Testing Recommendations

### Test 1: Basic Import Test
```bash
cd financial-normalizer
python3 -c "from src.classification.classifier import ClassificationEngine; print('âœ“ Imports work')"
```

### Test 2: Parse Sample Data
```bash
cd financial-normalizer
python3 << 'EOF'
from src.ingestion.trial_balance_parser import TrialBalanceParser

parser = TrialBalanceParser('data/input/sample_trial_balance.csv')
transactions = parser.parse()
print(f"âœ“ Loaded {len(transactions)} transactions")
print(f"  Total debit: ${sum(t.amount for t in transactions if t.amount > 0):,.2f}")
print(f"  Total credit: ${abs(sum(t.amount for t in transactions if t.amount < 0)):,.2f}")
EOF
```

### Test 3: Classify Accounts
```bash
cd financial-normalizer
python3 << 'EOF'
from src.classification.classifier import ClassificationEngine

classifier = ClassificationEngine()

# Test classification
test_accounts = [
    ("4000", "Product Revenue"),
    ("5000", "Cost of Goods Sold"),
    ("6000", "Salaries & Wages"),
    ("7000", "Interest Expense"),
]

for code, name in test_accounts:
    result = classifier.classify_account(code, name)
    print(f"{code} - {name}: {result.account_type.value}")
EOF
```

### Test 4: Full Pipeline
```bash
cd financial-normalizer
python3 << 'EOF'
from src.ingestion.trial_balance_parser import TrialBalanceParser
from src.classification.classifier import ClassificationEngine
import pandas as pd

# Parse data
parser = TrialBalanceParser('data/input/sample_trial_balance.csv')
transactions = parser.parse()

# Convert to DataFrame for classification
df = pd.DataFrame({
    'Account_Code': [t.account for t in transactions],
    'Account_Name': [t.description for t in transactions],
    'Amount': [t.amount for t in transactions],
})

# Classify accounts
classifier = ClassificationEngine()
df_classified = classifier.classify_dataframe(df)

print(f"âœ“ Classified {len(df_classified)} accounts")
print("\nSample classifications:")
print(df_classified[['Account_Code', 'Account_Type', 'Amount']].head(10))

# Detect suspicious patterns
flags = classifier.detect_suspicious_patterns(df)
if flags:
    print(f"\nâœ“ Found {len(flags)} suspicious patterns:")
    for flag in flags:
        print(f"  - {flag.pattern}: {flag.reason}")
else:
    print("\nâœ“ No suspicious patterns detected")
EOF
```

---

## Current Status

### âœ… Complete Modules
- [x] Trial Balance Parser
- [x] Account Classification Engine
- [x] Adjustment Calculator
- [x] EBITDA Calculation Engine
- [x] Consolidation Engine
- [x] Suspicious Pattern Detection
- [x] Configuration File (categories.yaml)
- [x] Sample Test Data (GreenPower LLC trial balance)

### âš ï¸ Incomplete/Stub Modules
- [ ] Export Module (currently empty - no export formats implemented)
- [ ] Main.py (only prints initialization message - no actual workflow)
- [ ] Tests directory (exists but empty - no unit tests)
- [ ] Error handling in export module

### ðŸ“ Notes
- Main application entry point (src/main.py) needs implementation
- No actual file export functionality (only reads are working)
- No web API or CLI interface
- Limited test coverage (no unit tests)

---

## Known Issues & Recommendations

### 1. Empty Export Module
**Issue**: Export module exists but is empty  
**Impact**: No way to save processed results to files  
**Recommendation**: Implement export formats:
- CSV export for transactions
- Excel export with multiple sheets
- JSON export for APIs
- PDF report generation

### 2. Minimal Main Script
**Issue**: main.py only prints initialization message  
**Impact**: No actual workflow when running python src/main.py  
**Recommendation**: Implement full pipeline:
```python
def main():
    # Parse input
    # Classify accounts
    # Apply adjustments
    # Generate EBITDA metrics
    # Export results
    # Print summary
```

### 3. No Test Suite
**Issue**: Tests directory exists but empty  
**Impact**: No automated testing, difficult to validate changes  
**Recommendation**: Create tests for:
- Parser edge cases (missing columns, invalid dates, etc.)
- Classification accuracy for different industries
- Adjustment calculations
- Multi-entity consolidations

### 4. Limited Documentation
**Issue**: Code is documented but no user guide or examples  
**Impact**: Difficult to use without reading source code  
**Recommendation**: Add examples and tutorials

---

## Configuration File (categories.yaml)

The `config/categories.yaml` file contains:

**Industries Defined**:
- `saas_tech`: SaaS/Technology companies
- `manufacturing`: Manufacturing companies
- `financial_services`: Banks, insurance companies

**Account Classifications**:
- Revenue accounts (4000s for SaaS, 1000s for manufacturing)
- COGS accounts with cost drivers
- Operating expenses (sales, R&D, G&A)

**Suspicious Patterns** (if defined):
- Large round numbers
- Related party transactions
- Unusual account combinations

---

## Sample Data

The project includes `data/input/sample_trial_balance.csv` with:
- **Entity**: GreenPower LLC (renewable energy company)
- **Period**: January - March 2024
- **Account Codes**: 5100-7300 range
- **Sample Entries**: 20 transactions
- **Total Debit**: $683,000

This is perfect for testing the pipeline.

---

## Quick Start Guide

1. **Install dependencies**:
   ```bash
   cd financial-normalizer
   pip install -r requirements.txt
   ```

2. **Test imports**:
   ```bash
   python3 test_imports.py
   ```

3. **Run classification on sample data**:
   ```bash
   python3 -c "from src.classification.classifier import classify_transaction_dataset; classify_transaction_dataset('data/input/sample_trial_balance.csv', 'data/output/classified.csv')"
   ```

4. **Explore the code**:
   - Start with `classifier.py` to understand account classification
   - Then look at `adjustments.py` for EBITDA calculations
   - Finally, review `engine.py` for the complete pipeline

---

## Next Steps

1. **Test the Current Implementation**
   - Run test commands above
   - Verify all imports work
   - Validate sample data processing

2. **Implement Export Module**
   - CSV/Excel export
   - JSON export
   - PDF reports

3. **Complete Main Script**
   - Create full workflow
   - Add command-line arguments
   - Add logging/progress indication

4. **Add Unit Tests**
   - Parser tests
   - Classification tests
   - EBITDA calculation tests
   - Consolidation tests

5. **Add Documentation**
   - User guide with examples
   - Industry-specific templates
   - Best practices guide

---

## Summary

Your financial normalization engine is **well-structured** and **feature-complete at the core level**. The main modules (parsing, classification, adjustments, EBITDA) are all fully implemented and ready to use. The project needs some additional work on:
- Export functionality
- Main application entry point
- Test coverage
- User documentation

The foundation is solid and the code quality is good!
